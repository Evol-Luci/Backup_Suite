# Backup Suite Documentation

## Overview

This backup suite provides a simple way to back up a specific directory structure using batch scripts. It utilizes `robocopy` for efficient file copying, PowerShell for creating zip archives, and includes a management script for handling file/directory exclusions. The suite also automatically manages backup rotation, keeping only the two most recent backups.

## Components

The suite consists of the following files, typically located together in a `Backup_Suite` directory:

1.  **`backup.bat`**: The core script that performs the backup operation.
2.  **`manage_exclusions.bat`**: A menu-driven script to manage the exclusion list and trigger the backup process.
3.  **`backup_exclusions.txt`**: A plain text file containing a list of directory or file names to be excluded from the backup. Each entry should be on a new line. This file is managed by `manage_exclusions.bat`.
4.  **`manage_exclusions_debug.log`**: A log file generated by `manage_exclusions.bat` to record actions and potential errors during exclusion management.

## Prerequisites

*   **Windows Operating System**: The scripts are designed for Windows batch processing (`.bat`).
*   **PowerShell**: `backup.bat` uses the `Compress-Archive` cmdlet available in PowerShell for creating zip files. This is typically included in modern Windows versions.
*   **Robocopy**: `backup.bat` relies on `robocopy.exe`, a standard Windows command-line utility for file replication.

## Usage

The primary way to interact with the backup suite is through `manage_exclusions.bat`.

1.  **Navigate** to the directory containing the scripts (e.g., `Backup_Suite`).
2.  **Run `manage_exclusions.bat`** by double-clicking it or executing it from the command line.
3.  You will be presented with a menu:

    ```
    ===================================
     Manage Backup Exclusions & Run
     File: "...\backup_exclusions.txt"
    ===================================
    Actions:
      ADD [item]    - Add 'item' to exclusions
      REMOVE [item] - Remove 'item' from exclusions
      LIST          - Show current exclusions
      RUN           - Execute the backup.bat script
      EXIT          - Quit this script
    ===================================

    > Enter action:
    ```

4.  **Available Actions:**
    *   **`ADD <item_name>`**: Adds the specified `item_name` (e.g., `node_modules`, `*.tmp`, `MyTempFolder`) to the `backup_exclusions.txt` file. The script prevents duplicate entries.
        *   Synonym: `EXCLUDE <item_name>`
    *   **`REMOVE <item_name>`**: Removes the exact `item_name` from the `backup_exclusions.txt` file. The match must be exact and case-insensitive.
        *   Synonym: `INCLUDE <item_name>`
    *   **`LIST`**: Displays the current contents of `backup_exclusions.txt` with line numbers. Shows "(Exclusion file is empty)" if the file is empty or doesn't exist.
    *   **`RUN`**: Executes the `backup.bat` script to perform the actual backup.
        *   Synonym: `BACKUP`
    *   **`EXIT`**: Closes the `manage_exclusions.bat` script.
        *   Synonym: `QUIT`

## Configuration and Backup Logic (`backup.bat`)

The `backup.bat` script determines the source and destination directories based on its own location:

*   **Script Directory (`script_dir`)**: The directory where `backup.bat` resides (e.g., `F:\...\Programming\Backup_Suite`).
*   **Target Source Directory (`target_source_dir`)**: The **parent directory** of the `script_dir` (e.g., `F:\...\Programming`). This is the directory that will be backed up.
*   **Grandparent Directory (`grandparent_dir`)**: The parent directory of the `target_source_dir` (e.g., `F:\...`).
*   **Backup Destination Folder (`backup_folder`)**: A folder named `Backups` located within the `grandparent_dir` (e.g., `F:\...\Backups`). This folder is created automatically if it doesn't exist.

**Backup Process:**

1.  **Path Calculation**: Determines the source, destination, and exclusion file paths as described above.
2.  **Exclusion Loading**: Reads each line from `backup_exclusions.txt` and builds `/XD` arguments for `robocopy`.
3.  **Destination Check**: Creates the `backup_folder` if it doesn't exist.
4.  **Timestamp Generation**: Gets the current date and time using `wmic` to create a unique timestamp (e.g., `YYYY-MM-DD_HH-MIN-SS`).
5.  **Temporary Copy**:
    *   Uses `robocopy` to copy the entire `target_source_dir` to a temporary folder within the `backup_folder` (e.g., `backup_copy_YYYY-MM-DD_HH-MIN-SS`).
    *   Applies exclusions defined in `backup_exclusions.txt`.
    *   **Crucially, it always excludes the `Backup_Suite` directory itself** to prevent the backup scripts from being included in the backup archive.
    *   Uses options `/E` (copy subdirectories, including empty ones), `/COPY:DAT` (copy Data, Attributes, Timestamps), `/R:1 /W:1` (retry once, wait 1 second), and options to minimize console output (`/NFL /NJH /NJS`) while showing ETA (`/ETA`).
6.  **Zipping**:
    *   If `robocopy` succeeds (exit code 0 or 1), it uses PowerShell's `Compress-Archive` to create a zip file (e.g., `Backup_YYYY-MM-DD_HH-MIN-SS.zip`) in the `backup_folder` from the contents of the temporary copy directory.
    *   Verifies that the zip file was actually created.
7.  **Temporary Folder Deletion**: Deletes the temporary copy directory (`backup_copy_*`).
8.  **Backup Rotation**:
    *   Counts the number of `Backup_*.zip` files in the `backup_folder`.
    *   If the count is greater than 2, it identifies the oldest backup file (by date in the filename) and deletes it.

## Troubleshooting

Both scripts include error handling and provide messages to the console.

**`manage_exclusions.bat` Errors:**

*   `ERROR: Could not create exclusion file. Check permissions.`: The script couldn't create `backup_exclusions.txt`. Check write permissions in the script's directory.
*   `Invalid command ...`: You entered an unrecognized command at the menu.
*   `ERROR: Please specify the item to add/remove...`: You used `ADD` or `REMOVE` without providing an item name.
*   `WARNING: "..." already exists. Not adding again.`: You tried to `ADD` an item already in the list.
*   `WARNING: "..." was not found. Nothing to remove.`: You tried to `REMOVE` an item not present in the list.
*   `ERROR: Failed creating temp file...`: An issue occurred while trying to rebuild the exclusion list during a `REMOVE` operation.
*   `ERROR: Failed replacing "..."`: The script couldn't replace the original exclusion file with the modified temporary one after a `REMOVE`. The temporary file (`.tmp`) might still exist.
*   `ERROR: Backup script "..." not found!`: The `backup.bat` file could not be found when trying to `RUN` the backup. Ensure both scripts are in the same directory.

**`backup.bat` Errors:**

*   `ERROR: Failed to create backup folder. Check permissions.`: The script couldn't create the `Backups` directory. Check write permissions in the grandparent directory.
*   `ERROR: Failed to get date/time from WMIC.`: The `wmic os get localdatetime` command failed. This is unusual but could indicate a WMI service issue.
*   `ERROR: Robocopy failed or had issues (Code ...).`: `robocopy` returned an error code greater than 1. Codes 0 and 1 indicate success (files copied, potentially extra files in destination). Higher codes indicate errors (see Robocopy documentation for specific codes). The temporary folder is deleted on failure.
*   `ERROR: Failed to create zip file with PowerShell. Exit Code ...`: The `Compress-Archive` command failed. Check PowerShell execution policies, disk space, or permissions. The temporary folder is deleted on failure.
*   `CRITICAL ERROR: Zip file "..." NOT found despite PowerShell success!`: PowerShell reported success (Exit Code 0), but the script couldn't find the created zip file. Check disk space and permissions in the `backup_folder`.
*   `ERROR: Failed to delete temporary folder "...". Check permissions or file locks.`: The script couldn't remove the `backup_copy_*` directory after zipping. Another process might have a file locked within it.
*   `WARN: Could not identify oldest backup file to delete...`: An issue occurred during the backup rotation logic.
*   `ERRORLEVEL ...: Failed to delete "...". Check permissions or lock.`: The script failed to delete the oldest backup during rotation. Check file permissions or locks on the specific zip file.

**General Tips:**

*   Review the `manage_exclusions_debug.log` for details on exclusion management steps.
*   Check permissions for the source directory, the script directory, and the destination `Backups` directory.
*   Ensure sufficient disk space in the destination drive.
*   If backups fail consistently, try running `backup.bat` directly from a command prompt to see more detailed output or error messages.
